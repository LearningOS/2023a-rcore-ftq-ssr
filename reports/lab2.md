# Lab2 CH4实验报告
  
## 实现功能总结
  为了实现sys_gettime功能，我用get_mut函数获取了那个物理页号的数组的指针然后在page_offset()位置修改变量的值就可以达到原本的功能要求。  
  
  对于task_info功能，我先是用translated_byte_buffer获取了那个位置的数组切片然后将上次任务得出的taskinfo的值复制给那个位置的数组切片。  
  
  mmap的映射，我先判了port和合法性与start有没有对齐，然后调用在pagetabel文件新建的函数，将port转为MapPermission类型的值，并加上U属性，
  然后从start到end遍历用if let与is_valid判断有没有已经创建过的页表项，最后用函数转到任务管理器中运行insert_framed_area分配内存。  

  munmap的功能，我先是和上面一样判断对齐然后循环找有没有还没创建过的页表项，最后用remove_area函数取消到 [start, start + len) 虚存的映射
## 简答作业
1. [63:54]为保留项，[53:10]这44位是物理页号，最低的8位[7:0]为标志位。  
    - V(Valid)：仅当位 V 为 1 时，页表项才是合法的；  
    - R(Read)/W(Write)/X(eXecute)：分别控制索引到这个页表项的对应虚拟页面是否允许读/写/执行；  
    - U(User)：控制索引到这个页表项的对应虚拟页面是否在 CPU 处于 U 特权级的情况下是否被允许访问；  
    - A(Accessed)：处理器记录自从页表项上的这一位被清零之后，页表项的对应虚拟页面是否被访问过；  
    - D(Dirty)：处理器记录自从页表项上的这一位被清零之后，页表项的对应虚拟页面是否被修改过。  
2. 缺页
    1. 第一题
       * Instruction page fault，Load page fault，与Store page fault
         


       * 寄存器的值
          mcause: Exception Code 为 12 时发生Instruction page fault，为 13 时发生Load page fault，为 15 时发生 Store page fault。
         
          scause: 中断/异常发生时，scause 中会记录其信息， Interrupt 位记录是中断还是异常， Exception Code 记录中断/异常的种类。

          sstatus: 记录处理器当前状态，其中 SPP 段记录当前特权等级。

          stvec: 记录处理 trap 的入口地址，现有两种模式 Direct 和 Vectored 。

          sscratch: 其中的值是指向hart相关的S态上下文的指针，比如内核栈的指针。

          sepc: trap 发生时会将当前指令的下一条指令地址写入其中，用于 trap 处理完成后返回。

          stval: trap 发生进入S态时会将异常信息写入，用于帮助处理 trap ，其中会保存导致缺页异常的虚拟地址。
    2. 第二题
       * Lazy策略可以提升系统的性能，因为有的页面没有用过程序就结束了，这样可以避免很多无用的加载。
    3. 第三题
       * 约为20MB
         
       * 分配内存时先不分配，等到触发缺页异常是，在trap handler里进行处理。
    4. 第四题
       * 页面失效会将标志位V置为0。
3. 双页表与单页表
    * 使用__switch来切换任务及对应页表
       
    * 将内核页面的pte的U标志位设置为0。
       
    * 在内核和用户态之间转换时不需要更换页表，可以像之前一样直接切换上下文。

    * 双页表实现下用户程序和内核转换时、用户程序转换时都需要更换页表，而对于单页表操作系统，不同用户线程切换时需要更换页表。
用户栈的栈指针保存在 sscratch 中，必须通过 csrr 指令读到通用寄存器中后才能使用。
## 荣誉准则

1. 在完成本次实验的过程（含此前学习的过程）中，我曾分别与 以下各位 就（与本次实验相关的）以下方面做过交流，还在代码中对应的位置以注释形式记录了
具体的交流对象及内容：

    -《你交流的对象说明》 与余智超,叶可禾交流了刚开始变量虚拟地址转物理地址的实现

2. 此外，我也参考了 以下资料 ，还在代码中对应的位置以注释形式记录了具体的参考来源及内容：

    -《你参考的资料说明》  仅参考了v3的书
    - 《RISC-V-Reader-Chinese-v2p1》中关于mcause缺页的异常

4. 我独立完成了本次实验除以上方面之外的所有工作，包括代码与文档。 我清楚地知道，从以上方面获得的信息在一定程度上降低了实验难度，可能会影响起评分。

5. 我从未使用过他人的代码，不管是原封不动地复制，还是经过了某些等价转换。 我未曾也不会向他人（含此后各届同学）复制或公开我的实验代码，我有义务妥
善保管好它们。 我提交至本实验的评测系统的代码，均无意于破坏或妨碍任何计算机系统的正常运转。 我清楚地知道，以上情况均为本课程纪律所禁止，若违反，
对应的实验成绩将按“-100”分计。
